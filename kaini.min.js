function setCookie(e,t,a){var l=a?"; domain="+a:"";document.cookie=e+"="+encodeURIComponent(t)+"; max-age=31536000; path=/"+l}function getCookie(e){for(var t=e+"=",a=document.cookie.split(";"),l=0;l<a.length;l++){for(var i=a[l];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(t))return decodeURIComponent(i.substring(t.length,i.length))}return null}function store(e,t){storage?localStorage.setItem(e,t):setCookie(e,t)}function restore(e){var t=null;return storage&&(t=localStorage.getItem(e))?t:getCookie(e)}function getBase64Image(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var a=t.getContext("2d");a.drawImage(e,0,0);var l=t.toDataURL("image/png");return l}var lang="en",globalship=null,globalbg=null,globalavatar=null,k2={},colle={},shipDB={},fleets=[new Array(6),new Array(6),new Array(6),new Array(6)],fleetLevels=[[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1]],Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,a,l,i,n,s,o,r="",c=0;for(e=Base64._utf8_encode(e);c<e.length;)t=e.charCodeAt(c++),a=e.charCodeAt(c++),l=e.charCodeAt(c++),i=t>>2,n=(3&t)<<4|a>>4,s=(15&a)<<2|l>>6,o=63&l,isNaN(a)?s=o=64:isNaN(l)&&(o=64),r=r+Base64._keyStr.charAt(i)+Base64._keyStr.charAt(n)+Base64._keyStr.charAt(s)+Base64._keyStr.charAt(o);return r},decode:function(e){var t,a,l,i,n,s,o,r="",c=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");c<e.length;)i=Base64._keyStr.indexOf(e.charAt(c++)),n=Base64._keyStr.indexOf(e.charAt(c++)),s=Base64._keyStr.indexOf(e.charAt(c++)),o=Base64._keyStr.indexOf(e.charAt(c++)),t=i<<2|n>>4,a=(15&n)<<4|s>>2,l=(3&s)<<6|o,r+=String.fromCharCode(t),64!=s&&(r+=String.fromCharCode(a)),64!=o&&(r+=String.fromCharCode(l));return r=Base64._utf8_decode(r)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",a=0;a<e.length;a++){var l=e.charCodeAt(a);128>l?t+=String.fromCharCode(l):l>127&&2048>l?(t+=String.fromCharCode(l>>6|192),t+=String.fromCharCode(63&l|128)):(t+=String.fromCharCode(l>>12|224),t+=String.fromCharCode(l>>6&63|128),t+=String.fromCharCode(63&l|128))}return t},_utf8_decode:function(e){for(var t="",a=0,l=c1=c2=0;a<e.length;)l=e.charCodeAt(a),128>l?(t+=String.fromCharCode(l),a++):l>191&&224>l?(c2=e.charCodeAt(a+1),t+=String.fromCharCode((31&l)<<6|63&c2),a+=2):(c2=e.charCodeAt(a+1),c3=e.charCodeAt(a+2),t+=String.fromCharCode((15&l)<<12|(63&c2)<<6|63&c3),a+=3);return t}},storage=function(){var e,t,a=new Date;try{return(e=window.localStorage).setItem(a,a),t=e.getItem(a)==a,e.removeItem(a),t&&e}catch(l){}}();$(document).ready(function(){$(".shipClass").each(function(){for(var e=$(this).find("input").length,t=new Array(e);e--;)t[e]=!1;k2[this.id]=t});var e={},t=0,a=0,l={},i={},n=0;$.ajax({dataType:"json",timeout:1e4,url:"en"==lang?"db.json":"dbj.json"}).then(function(e){shipDB=e,$.ajax({dataType:"json",timeout:1e4,url:"conversion.json"}).then(function(e){l=e,N()},function(e){console.log("import db not found or invalid format, not performing import"),N()})},function(){$("#buttons").html("Can't find DB, please contact Ryuuhou Kagiyama on Himeuta.net"),$("#tabs").remove()});var s={"016.png":{x:0,y:-140},"017.png":{x:0,y:-140},"021.png":{x:0,y:-140},"026.png":{x:0,y:-140},"037.png":{x:0,y:-140},"042a.png":{x:0,y:70},"042b.png":{x:0,y:70},"046.png":{x:0,y:-140},"057.png":{x:0,y:-140}},o=document.getElementById("result"),r=o.getContext("2d"),c=.523598776,d=24,h=Math.sin(c)*d,g=Math.cos(c)*d,p=d+2*h,f=2*g,v=(5*p/4-f)/2,u=(5*p/4-p)/2+5,m="'Ubuntu', 'メイリオ', Times, serif",b="'Exo', 'メイリオ', Times, serif",y=function(e){d=e,h=Math.sin(c)*d,g=Math.cos(c)*d,p=d+2*h,f=2*g,v=(5*p/4-f)/2,u=(5*p/4-p)/2+5},k=function(){var e=$(".furnitureClass input:checked").toArray(),t={};for(var a in e)t[e[a].name]=e[a].id;$(".shipClass").each(function(){var e=this.id,t=$(this).find("input"),a={};t.each(function(e){a[this.id]=$(this).prop("checked")}),k2[e]=a}),store("ttkName",$("input[name='name']").val()),store("ttkLvl",$("input[name='level']").val()),store("ttkServer",$("select[name='server']").val()),store("ttkFurn",Base64.encode(JSON.stringify(t))),store("ttkFurnCam",$("#roomY").val()),store("ttkTint",$("#tint-color").val()),store("ttkHexOpa",$("#hexOpa").val()),store("k2",Base64.encode(JSON.stringify(k2))),store("secretaryCam",JSON.stringify([$("#customX").val(),$("#customY").val(),$("#customZ").val()])),store("secretaryHit",$(".damaged").size()>0&&!$($(".damaged")[0]).hasClass("abyss"))?!0:!1,store("fleet",Base64.encode(fleets.join("|"))),store("fleetLvl",Base64.encode(fleetLevels.join("|"))),store("colle",Base64.encode(JSON.stringify(colle))),store("bg",globalbg),store("bgUse",$("#useBG").prop("checked")),store("bgCam",JSON.stringify([$("#bgX").val(),$("#bgY").val(),$("#bgZ").val()])),store("bgStretch",$("#bgStretch").prop("checked")),store("avatar",globalavatar)},C=function(){$(".flagship").removeClass("flagship"),$(".damaged").removeClass("damaged"),$("input[name='name']").val(restore("ttkName")),$("input[name='level']").val(restore("ttkLvl"));var e=restore("bgCam");e=e?JSON.parse(e):[0,0,100],$("#bgX").val(e[0]),$("#bgY").val(e[1]),$("#bgZ").val(e[2]),$("#useBG").prop("checked",!restore("bgUse")||"true"==restore("bgUse"));var t=restore("secretaryCam");t=t?JSON.parse(t):[0,0,0],$("#customX").val(t[0]),$("#customY").val(t[1]),$("#customZ").val(t[2]),$("#roomY").val(restore("ttkFurnCam")||0),$("#tint-color").val(restore("ttkTint")||"#ffffff"),$("#hexOpa").val(restore("ttkHexOpa")||.33),$("#hexOpa").val(restore("ttkHexOpa")||.33),$("#bgStretch").prop("checked",!restore("bgStretch")||"true"==restore("bgStretch")),globalbg=restore("bg"),"null"!=globalbg&&$("#bg").attr("src",globalbg),globalavatar=restore("avatar"),"null"!=globalavatar?$("#avatar").attr("src",globalavatar):$("#avatar").removeAttr("src");var a=restore("ttkServer");"null"!=a&&$("select[name='server']").val(a);var l=restore("k2");l=l?JSON.parse(Base64.decode(l)):null;var i=restore("colle");i=i?JSON.parse(Base64.decode(i)):null;var s=restore("ttkFurn");s=s?JSON.parse(Base64.decode(s)):null;var o=restore("fleet");o=o?Base64.decode(o).split("|"):null;for(var r in o)o[r]=o[r].split(",");var c=restore("fleetLvl");c=c?Base64.decode(c).split("|"):null;for(var r in c)c[r]=c[r].split(",");if(l){k2=l,$(".shipClass input").prop("checked",!1);for(var r in k2)for(var d in k2[r])$("#"+d).prop("checked",k2[r][d])}if(i){colle=i,$("#colleDiv img").removeClass("selected");for(var r in colle)$("#kore"+r).addClass("selected")}if(o){fleets=o;for(var r in fleets[0]){var h=fleets[0][r];if(null!==h&&""!==h){0==r&&($("#"+h).addClass("flagship"),"true"==restore("secretaryHit")&&$("#"+h).next("span").addClass("damaged"),n=shipDB[h.substring(4)]?shipDB[h.substring(4)].rarity:0);var g=parseInt(r)+1;$("#slot"+g).html('<img style="height:50px; width:50px;" src="'+$("#"+h).attr("src")+'"/>')}}}if(c){fleetLevels=c;for(var r in fleetLevels[0]){var p=parseInt(fleetLevels[0][r]);if(p&&p>0){var g=parseInt(r)+1;$("#level"+g).val(p)}}}if(s){var f=0;$("#buttons button").prop("disabled",!0),$("#loadingDiv").html("Rendering...");var v=!1;for(var r in s){var u=s[r],m=$("#"+u);m.prop("checked",!0);var b=m.parent().parent().parent().attr("id"),y=$("#active"+b);if(y.off("load"),"Outside"==b){var k=$("#Outside").find(":checked"),C=$("#Window").find(":checked").attr("data-pType"),x=k.val()+C,S="furniture/outside/"+x+".png";y.attr("src",S)}else{var x=m.val();y.attr("src","furniture/"+b.toLowerCase()+"/"+x+".png")}y.prop("complete")?(f++,f==Object.keys(s).length&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?O(132):w("loadAllImgCached"))):y.load(function(){f++,f==Object.keys(s).length&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(v?"Couldn't find a furniture's image.":""),$("#displayRoom").hasClass("on")?O(132):w("loadAllImgLoaded"))}).error(function(e){f++,v=!0,f==Object.keys(s).length&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html("Couldn't find a furniture's image."))})}}else w("loadNoFurniture")},x=function(){if($(this).hasClass("abyss")||(fleets[t][a]=$(this).prev("img").attr("id"),$("#fleets .chosen").html('<img style="height:50px; width:50px;" src="'+$(this).prev("img").attr("src")+'"/>')),0==t&&0==a){$(this).hasClass("damaged")||$(".damaged").removeClass("damaged"),$(this).toggleClass("damaged"),$(".flagship").removeClass("flagship");var e=$(this).prev("img");e.toggleClass("flagship"),n=shipDB[$(this).prev("img").attr("id").substring(4)]?shipDB[$(this).prev("img").attr("id").substring(4)].rarity:0,w("fleetFlagshipChange")}},S=function(){$("#loadAbyss").remove(),$("#avatars .hidden").removeClass("hidden"),$.ajax({dataType:"json",timeout:1e4,url:"en"==lang?"db2.json":"db2j.json",success:function(e){i=e,$("#loadingDiv").html("Loading images: "),$("#loadingProgress").show().html("0/"+Object.keys(e).length);var t=0;for(var a in i){var l=e[a];if(l.name){var s=$('<img class="abyss tooltip2" title="'+l.full+'" src="icons/'+l.type+"/"+a+'.png" id="icon'+a+'"></img>'),o=$('<span class="abyss" id="hit'+a+'">破</span>');s.on("load",function(){t++,$("#loadingProgress").html(t+"/"+Object.keys(e).length),t==Object.keys(e).length&&($("#loadingDiv").html(""),$("#loadingProgress").hide())}),s.on("click",function(){$(".flagship").removeClass("flagship"),$(".damaged").removeClass("damaged"),$(this).toggleClass("flagship"),n=0,w("fleetShipChangeAbyss")}),0==$(".shipList [data-name='"+l.name+"']").length&&$(".div"+l.type).append("<div><label>"+l.name.replace(new RegExp("_","g")," ")+'</label><div data-name="'+l.name+'" class="'+l.type+'"></div></div>'),$("#avatars [data-name='"+l.name+"']").append(s),l.damageable&&$("#avatars [data-name='"+l.name+"']").append(o)}}$("#avatars span").unbind("click").on("click",x),$(".tooltip2").tooltipster()},error:function(){$("#loadingDiv").html("Can't find Abyssal DB, please contact Pink Ryuuhou on Himeuta.net")}})},w=function(e){if(console.log(e),$("#loadingDiv").html("Rendering..."),$("#buttons button").prop("disabled",!0),$("#save").prop("disabled",!0),r.clearRect(0,0,o.width,o.height),r.save(),r.fillStyle="#666",r.fillRect(0,0,o.width,o.height),$("#useBG").prop("checked"))O("displayBadge"!=$("#buttonToggles .active").attr("id")?132:parseInt(document.getElementById("roomY").value)),r.globalAlpha=.33,r.fillRect(0,0,o.width,o.height);else{var t=document.getElementById("bg"),a=$("#bgStretch").prop("checked"),l=$("#bgX").val()||0,i=$("#bgY").val()||0,n=$("#bgZ").val()||0;r.drawImage(t,l,i,a?o.width:t.width*(n/100),a?o.height:t.height*(n/100))}r.restore(),r.strokeRect(0,0,o.width,o.height),D()},I=function(e,t){var a=$("#avatar"),l=$(".flagship")[0]?$(".flagship")[0].id.substring(4):null,s=!1;l&&$("#hit"+l).hasClass("damaged")&&(s=!0);var c=$(".flagship").parent().length>0?$(".flagship").parent().attr("class"):null;if(null!=globalship){var d=new Image;d.onload=function(){var a=0,l=0;a+=document.getElementById("customX").value?parseInt(document.getElementById("customX").value):0,l+=document.getElementById("customY").value?parseInt(document.getElementById("customY").value):0,r.save();var i=document.getElementById("customZ").value?parseInt(document.getElementById("customZ").value)+100:100;i/=100,r.translate(o.width-7*d.width/8+a,o.height/2-d.height/5+l),r.translate(d.width/2,d.height/2),r.scale(i,i),r.drawImage(d,-d.width/2,-d.height/2),r.restore(),e(),t||A(r)},d.onerror=e,d.src=globalship}else if(l){var d=new Image;d.onload=function(){var c=0,h=0;0==n&&i[l]?s&&i[l].offset2?(c=i[l].offset2.x,h=i[l].offset2.y):(c=i[l].offset.x,h=i[l].offset.y):shipDB[l]&&(s&&shipDB[l].offset2?(c=shipDB[l].offset2.x,h=shipDB[l].offset2.y):shipDB[l].offset&&(c=shipDB[l].offset.x,h=shipDB[l].offset.y)),c+=document.getElementById("customX").value?parseInt(document.getElementById("customX").value):0,h+=document.getElementById("customY").value?parseInt(document.getElementById("customY").value):0,r.save();var g=document.getElementById("customZ").value?parseInt(document.getElementById("customZ").value)+100:100;g>=50&&150>=g?(g/=100,r.translate(o.width-7*d.width/8+c,o.height/2-d.height/5+h),r.translate(d.width/2,d.height/2),r.scale(g,g),r.drawImage(d,-d.width/2,-d.height/2)):r.drawImage(d,o.width-7*d.width/8+c,o.height/2-d.height/5+h),r.restore(),e(),t||(a.attr("src")?A(r):B(r,l,n))},d.onerror=e,d.src="full/"+c+"/"+l+(s?"x":"")+".png"}else e(),a.attr("src")&&!t&&A(r)},B=function(e,t,a){var a=document.getElementById("r"+a),l=document.getElementById("icon"+t);e.save(),e.fillStyle="black",e.fillRect(35,45,100,100),e.strokeRect(35,45,100,100),e.restore(),e.drawImage(a,30,5,100,100,35,45,100,100),e.drawImage(l,35,45)},A=function(e){var t=document.getElementById("avatar");e.save(),e.fillStyle="transparent",e.fillRect(35,45,100,100),e.strokeRect(35,45,100,100),e.restore(),e.drawImage(t,35,45,100,100)},D=function(){var e=$("#buttonToggles .active").attr("id");"displayBadge"==e?I($("#k2").prop("checked")?F:j):"displayPoster"==e?I(E,!0):"displayRoom"==e&&O(132)},E=function(){var e=10;y(e),r.save();var t=$("[name='name']")[0],a=$("[name='level']")[0],l=$("[name='server'] :selected").text(),i=($("#useBlue").prop("checked"),40),n=e*(2*Math.sin(Math.PI/2)+1),s=55,c=o.height-10,d=40,h=d+15,p=d+g,v=h+g,u=540;r.font="20px "+m,r.imageSmoothingEnabled=!0,r.fillStyle="white",r.strokeStyle="black",t.value?L(t.value,20,25,3):L("en"==lang?"Nameless Admiral":"無名提督",20,25,3),r.save(),r.font="10px "+m,r.globalCompositeOperation="lighter",r.fillStyle="rgba(255, 255, 255, 0.25)",r.strokeStyle="transparent";var k=new Date;L(k.getFullYear()+"-"+(k.getMonth()+1)+"-"+k.getDate(),5,o.height-5,3),r.restore(),r.font="14px "+m,r.textAlign="right",L("en"==lang?"DD":"駆",d,s+e-9);var C=0,x=$("#colleDiv .divDD img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divDD img").each(function(e){var t=h+C%i*f;Math.floor(C/i%2)>0&&(t=h+(i-C%i)*f-g);var a=Math.floor(C/i)*+n/2+s-15,l=document.getElementById(this.id);R(l,t,a,$(this).hasClass("selected"),!1),C++}),r.textAlign="left",r.font="14px "+b,L(x+"/"+C+" ("+(x/C*100).toFixed()+"%)",h+i*f+8,s),r.restore();var S=s+n+n/4+8*Math.floor(C/i),w=S+n/2+n/4,I=w+n/2+n/4,B=I+n/2+n/4,A=B+n/2+n/4,D=A+n/2+n/4,E=D+n/2+n/4;L("en"==lang?"CL":"軽巡",p,S+e-9);var O=0,F=$("#colleDiv .divCL img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divCL img").each(function(){var e=v+O*f,t=S-15,a=document.getElementById(this.id);R(a,e,t,$(this).hasClass("selected"),!1),O++}),r.textAlign="left",r.font="14px "+b,L(F+"/"+O+" ("+(F/O*100).toFixed()+"%)",v+O*f+8,S),r.restore(),L("en"==lang?"CA":"重巡",d,w+e-9);var j=0,T=$("#colleDiv .divCA img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divCA img").each(function(){var e=h+j*f,t=w-15,a=document.getElementById(this.id);R(a,e,t,$(this).hasClass("selected"),!1),j++}),r.textAlign="left",r.font="14px "+b,L(T+"/"+j+" ("+(T/j*100).toFixed()+"%)",h+j*f+8,w),r.restore(),L("en"==lang?"CVL":"軽母",d,B+e-9);var N=0,_=$("#colleDiv .divCVL img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divCVL img").each(function(){var e=h+N*f,t=B-15,a=document.getElementById(this.id);R(a,e,t,$(this).hasClass("selected"),!1),N++}),r.textAlign="left",r.font="14px "+b,L(_+"/"+N+" ("+(_/N*100).toFixed()+"%)",h+N*f+8,B),r.restore(),L("en"==lang?"BB":"戦",p,I+e-9);var W=0,M=$("#colleDiv .divBB img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divBB img").each(function(){var e=v+W*f,t=I-15,a=document.getElementById(this.id);R(a,e,t,$(this).hasClass("selected"),!1),W++}),r.textAlign="left",r.font="14px "+b,L(M+"/"+W+" ("+(M/W*100).toFixed()+"%)",v+W*f+8,I),r.restore(),L("en"==lang?"CV":"航",p,A+e-9);var Y=0,P=$("#colleDiv .divCV img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divCV img").each(function(){var e=v+Y*f,t=A-15,a=document.getElementById(this.id);R(a,e,t,$(this).hasClass("selected"),!1),Y++}),r.textAlign="left",r.font="14px "+b,L(P+"/"+Y+" ("+(P/Y*100).toFixed()+"%)",v+Y*f+8,A),r.restore(),L("en"==lang?"SS":"潜",d,D+e-9);var H=0,U=$("#colleDiv .divSS img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divSS img").each(function(){var e=h+H*f,t=D-15,a=document.getElementById(this.id);R(a,e,t,$(this).hasClass("selected"),!1),H++}),r.textAlign="left",r.font="14px "+b,L(U+"/"+H+" ("+(U/H*100).toFixed()+"%)",v+H*f+8,D),r.restore(),L("en"==lang?"AX":"他",p,E+e-9);var J=0,X=$("#colleDiv .divAX img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divAX img").each(function(){var e=v+J*f,t=E-15,a=document.getElementById(this.id);R(a,e,t,$(this).hasClass("selected"),!1),J++}),r.textAlign="left",r.font="14px "+b,L(X+"/"+J+" ("+(X/J*100).toFixed()+"%)",v+J*f+8,E),r.restore(),r.font="12px "+m;var Z=$("#colleDiv"),V=Z.find("img.selected").length,G=Z.find("img").length,z=V+"/"+G,K=V/G,q=300;r.save(),r.strokeRect(u,c-10,q,8);var Q=r.createLinearGradient(u,0,u+q,0);Q.addColorStop(0,"#A00000"),Q.addColorStop(.33,"#FF9900"),Q.addColorStop(.66,"#DDDD33"),Q.addColorStop(1,"#00A000"),r.fillStyle=Q,r.fillRect(u,c-10,(q*K).toFixed(),8),r.restore(),r.font="20px "+b,L(z+" ("+(100*K).toFixed()+"%)",u+q,c-n/2,3),r.font="12px "+m,r.textAlign="right",L("Lv. "+(a.value?a.value:"?"),o.width/2,25),"Your Server"!=l?L(l.substring(l.indexOf(" ")+1),o.width-25,25):L("en"==lang?"Unknown Server":"不明サーバ",o.width-25,25),r.textAlign="left",r.restore(),$("#loadingDiv").html(""),$("#loadingProgress").hide(),$("#buttons button").prop("disabled",!1)},O=function(e){var t=o.width/bg.clientWidth,a=document.getElementById("activeFloor"),l=document.getElementById("activeWall"),i=document.getElementById("activeDesk"),n=document.getElementById("activeOutside"),c=document.getElementById("activeWindow"),d=document.getElementById("activeObject"),h=document.getElementById("activeChest");r.globalAlpha=1,t=o.width/a.clientWidth,a.complete&&r.drawImage(a,0,150*t+e,o.width,a.clientHeight*t),l.complete&&r.drawImage(l,0,-125*t+e,o.width,l.clientHeight*t),d.complete&&r.drawImage(d,0,-125*t+e,d.clientWidth*t,d.clientHeight*t),n.complete&&r.drawImage(n,210,-125*t+e,n.clientWidth*t,n.clientHeight*t),c.complete&&r.drawImage(c,210,-125*t+e,c.clientWidth*t,c.clientHeight*t);var g=i.src.match(/(\d\d\d.?).png$/gm),p=null;g&&(p=s[g[0]]),p?r.drawImage(i,p.x,p.y+e+7,i.clientWidth*t,i.clientHeight*t):r.drawImage(i,0,e+7,i.clientWidth*t,i.clientHeight*t),r.drawImage(h,o.width-h.clientWidth*t,-125*t+e,h.clientWidth*t,h.clientHeight*t);var f=$("#tint-color").val();r.fillStyle=f?f:"#ffffff",$("#loadingDiv").html(""),$("#loadingProgress").hide(),$("#buttons button").prop("disabled",!1)},L=function(e,t,a,l){r.save(),r.lineWidth="undefined"!=typeof l?l:2,r.strokeText(e,t,a),r.fillText(e,t,a),r.restore()},R=function(e,t,a,l,i){r.save(),r.beginPath(),r.moveTo(t+g,a),r.lineTo(t+f,a+h),r.lineTo(t+f,a+h+d),r.lineTo(t+g,a+p),r.lineTo(t,a+d+h),r.lineTo(t,a+h),r.closePath(),r.stroke(),r.fillStyle=i?i:"white",r.globalAlpha=$("#hexOpa").val()?$("#hexOpa").val():0,r.fill(),r.globalAlpha=1,r.clip(),e&&l&&r.drawImage(e,t-v,a-u,5*p/4,5*p/4),r.restore()},F=function(){y(22),r.save(),r.strokeRect(35,45,100,100);var e=$("[name='name']")[0],t=$("[name='level']")[0],a=$("[name='server'] :selected").text(),l=45,i=l+1.5*d+8,n=i+1.5*d+8,s=n+1.5*d+8,o=210,c=o+15,h=o+g,p=c+g,v=h+g,u=p+g,b=v+g,k=u+g;r.font="20px "+m,r.imageSmoothingEnabled=!0,r.fillStyle="white",r.strokeStyle="black",e.value?L(e.value,20,25,3):L("en"==lang?"Nameless Admiral":"無名提督",20,25,3),r.save(),r.font="10px "+m,r.globalCompositeOperation="darker",r.fillStyle="rgba(255, 255, 255, 0.25)",r.strokeStyle="transparent";var C=new Date;L(C.getFullYear()+"-"+(C.getMonth()+1)+"-"+C.getDate(),5,200,3),r.restore(),r.font="14px "+m,r.textAlign="right",r.drawImage(document.getElementById("fleet1a"),o-23,l+d/2-15),r.drawImage(document.getElementById("fleet2a"),h-23,i+d/2-15),r.drawImage(document.getElementById("fleet3a"),v-23,n+d/2-15),r.drawImage(document.getElementById("fleet4a"),b-23,s+d/2-15),r.save(),r.fillStyle="white";for(var x=0;6>x;x++){var S=c+x*f,w=l-15,I=document.getElementById(fleets[0][x]),B=fleetLevels[0][x];R(I,S,w,!0),I&&(r.font="10px "+m,r.textAlign="left",L(B,S,w+8));var S=p+x*f,w=i-15,I=document.getElementById(fleets[1][x]),B=fleetLevels[1][x];R(I,S,w,!0),I&&(r.font="10px "+m,r.textAlign="left",L(B,S,w+8));var S=u+x*f,w=n-15,I=document.getElementById(fleets[2][x]),B=fleetLevels[2][x];R(I,S,w,!0),I&&(r.font="10px "+m,r.textAlign="left",L(B,S,w+8));var S=k+x*f,w=s-15,I=document.getElementById(fleets[3][x]),B=fleetLevels[3][x];R(I,S,w,!0),I&&(r.font="10px "+m,r.textAlign="left",L(B,S,w+8))}r.restore(),r.font="12px "+m,r.textAlign="center",L("Lv. "+(t.value?t.value:"?"),85,s-1),"Your Server"!=a?L(a.substring(a.indexOf(" ")+1),85,s+14):L("en"==lang?"Unknown Server":"不明サーバ",85,s+14),r.textAlign="left",r.restore(),$("#loadingDiv").html(""),$("#buttons button").prop("disabled",!1)},j=function(){var e=16;y(e),r.save(),r.strokeRect(35,45,100,100);var t=$("[name='name']")[0],a=$("[name='level']")[0],l=$("[name='server'] :selected").text(),i=$("#useBlue").prop("checked"),n=12,s=e*(2*Math.sin(Math.PI/2)+1),o=55,c=o+s,d=c+s,h=175,p=175,v=p+15,u=p+g,k=v+g,C=540;r.font="20px "+m,r.imageSmoothingEnabled=!0,r.fillStyle="white",r.strokeStyle="black",t.value?L(t.value,20,25,3):L("en"==lang?"Nameless Admiral":"無名提督",20,25,3),r.save(),r.font="10px "+m,r.globalCompositeOperation="lighter",r.fillStyle="rgba(255, 255, 255, 0.25)",r.strokeStyle="transparent";var x=new Date;L(x.getFullYear()+"-"+(x.getMonth()+1)+"-"+x.getDate(),5,200,3),r.restore(),r.font="14px "+m,r.textAlign="right",L("en"==lang?"DD":"駆",p,o+e-9);var S=0,w=$("#dd").find("[type='checkbox']:checked").length,I=0;r.save(),r.fillStyle="white",$("#dd").find("[type='checkbox']").each(function(e){var t=$(this).parent().parent();if(i&&t.hasClass("blueprint")&&!t.hasClass("kai"))this.checked&&t.hasClass("blueprint")&&I++;else{var a=v+S%n*f;Math.floor(S/n%2)>0&&(a=v+(n-S%n)*f-g);var l=Math.floor(S/n)*-s/2+o-15,r=document.getElementById("icon"+this.id),c=t.hasClass("blueprint")?"lightblue":"white";R(r,a,l,this.checked,c),S++}}),r.textAlign="left",r.font="14px "+b,L(w-I+"/"+S,v+n*f+8,o+e-9),r.restore(),L("en"==lang?"CL":"軽巡",u,o+s/2+e-9);var B=0,A=$("#cl").find("[type='checkbox']:checked").length,I=0;r.save(),r.fillStyle="white",$("#cl").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(i&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&I++;else{var t=k+B*f,a=o-15+s/2,l=document.getElementById("icon"+this.id),n=e.hasClass("blueprint")?"lightblue":"white";R(l,t,a,this.checked,n),B++}}),r.textAlign="left",r.font="14px "+b,L(A-I+"/"+B,k+B*f+8,o+e-9+s/2),r.restore(),L("en"==lang?"CA":"重巡",p,c+e-9);var D=0,E=$("#ca").find("[type='checkbox']:checked").length,I=0;r.save(),r.fillStyle="white",$("#ca").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(i&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&I++;else{var t=v+D*f,a=c-15,l=document.getElementById("icon"+this.id),n=e.hasClass("blueprint")?"lightblue":"white";R(l,t,a,this.checked,n),D++}}),r.textAlign="left",r.font="14px "+b,L(E-I+"/"+D,v+D*f+8,c+e-9),r.restore(),L("en"==lang?"CVL":"軽母",p,d+e-9);var O=0,F=$("#cvl").find("[type='checkbox']:checked").length,I=0;r.save(),r.fillStyle="white",$("#cvl").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(i&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&I++;else{var t=v+O*f,a=d-15,l=document.getElementById("icon"+this.id),n=e.hasClass("blueprint")?"lightblue":"white";R(l,t,a,this.checked,n),O++}}),r.textAlign="left",r.font="14px "+b,L(F-I+"/"+O,v+O*f+8,d+e-9),r.restore(),L("en"==lang?"BB":"戦",u,c+s/2+e-9);var j=0,T=$("#bb").find("[type='checkbox']:checked").length,I=0;r.save(),r.fillStyle="white",$("#bb").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(i&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&I++;else{var t=k+j*f,a=c-15+s/2,l=document.getElementById("icon"+this.id),n=e.hasClass("blueprint")?"lightblue":"white";R(l,t,a,this.checked,n),j++}}),r.textAlign="left",r.font="14px "+b,L(T-I+"/"+j,k+j*f+8,c+e-9+s/2),r.restore(),L("en"==lang?"CV":"航",u,d+s/2+e-9);var N=0,_=$("#cv").find("[type='checkbox']:checked").length,I=0;r.save(),r.fillStyle="white",$("#cv").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(i&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&I++;else{var t=k+N*f,a=d-15+s/2,l=document.getElementById("icon"+this.id),n=e.hasClass("blueprint")?e.hasClass("prototype")?"pink":"lightblue":"white";R(l,t,a,this.checked,n),N++}}),r.textAlign="left",r.font="14px "+b,L(_-I+"/"+N,k+N*f+8,d+e-9+s/2),r.restore();var W=(N+3)*f;L("en"==lang?"SS":"潜",u+W,d+s/2+e-9);var M=0,Y=$("#ss").find("[type='checkbox']:checked").length,I=0;r.save(),r.fillStyle="white",$("#ss").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(i&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&I++;else{var t=W+k+M*f,a=d-15+s/2,l=document.getElementById("icon"+this.id),n=$(this).parent().parent().find("label").hasClass("blueprint")?"lightblue":"white";R(l,t,a,this.checked,n),M++}}),r.textAlign="left",r.font="14px "+b,L(Y-I+"/"+M,W+k+M*f+8,d+e-9+s/2),r.restore(),r.font="12px "+m;var P=$(".shipOptions"),H=P.find(".blueprint").length-P.find(".kai").length,U=P.find(".blueprint :checked").length-P.find(".kai :checked").length,J=i?P.find("[type='checkbox']:checked").length-U:P.find("[type='checkbox']:checked").length,X=i?P.find("[type='checkbox']").length-H:P.find("[type='checkbox']").length,Z=J+"/"+X,V=J/X,G=300;r.save(),r.strokeRect(C,d+4+s/2,G,8);var z=r.createLinearGradient(C,0,C+G,0);z.addColorStop(0,"#A00000"),z.addColorStop(.33,"#FF9900"),z.addColorStop(.66,"#DDDD33"),z.addColorStop(1,"#00A000"),r.fillStyle=z,r.fillRect(C,d+4+s/2,(G*V).toFixed(),8),r.restore(),r.font="20px "+b,L(Z+" ("+(100*V).toFixed()+"%)",C+G,d+4+s/2,3),r.font="12px "+m,r.textAlign="center",L("Lv. "+(a.value?a.value:"?"),85,h-8),"------"!==l?L("en"==lang?l.substring(l.indexOf(" ")+1):l,85,h+7):L("en"==lang?"Unknown Server":"不明サーバ",85,h+7),r.textAlign="left",r.restore(),$("#loadingDiv").html(""),$("#loadingProgress").hide(),$("#buttons button").prop("disabled",!1)},T=function(){for(var e in colle)$("#kore"+e).addClass("selected");$(".flagship").removeClass("flagship"),$(".damaged").removeClass("damaged");for(var e in fleets[0]){var t=fleets[0][e],a=t.substring(4);if(null!==t&&""!==t){0==e&&($("#"+t).addClass("flagship"),n=shipDB[a]?shipDB[a].rarity:0);var l=parseInt(e)+1;$("#slot"+l).html('<img style="height:50px; width:50px;" src="icons/'+shipDB[a].type+"/"+a+'.png"/>')}}for(var e in fleetLevels[0]){var i=parseInt(fleetLevels[0][e]);if(i&&i>0){var l=parseInt(e)+1;$("#level"+l).val(i)}}w("initial")},N=function(){var i=$.extend({},l.mstId2FleetIdTable,l.mstId2KainiTable);if(apiMode){if(importName&&$("input[name='name']").val(importName),importLvl&&$("input[name='level']").val(importLvl),importServer&&$("select[name='server']").val(importServer),importShips){importShips=JSON.parse(importShips);var s={},c={};for(var d in importShips)if(importShips[d]in i){var h=i[importShips[d]];if(s[h]=!0,h in l.implicationTable)for(var g in l.implicationTable[h])s[l.implicationTable[h][g]]=!0}if(importK2){for(var d in s){var h=$("#"+d);if(h.length>0){var p=shipDB[d].type;c[p]||(c[p]={}),c[p][d]=!0,$("#"+d).prop("checked",!0)}}k2=c}importColle&&(colle=s)}if(importFleets){importFleets=JSON.parse(importFleets);var f=[new Array(6),new Array(6),new Array(6),new Array(6)],v=[[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1]];for(var u in importFleets)for(var d in importFleets[u])importFleets[u][d]&&null!=importFleets[u][d]&&i[importFleets[u][d].id]&&(f[u][d]="icon"+i[importFleets[u][d].id],v[u][d]=importFleets[u][d].lvl);fleets=f,fleetLevels=v}}r.strokeRect(0,0,o.width,o.height),r.imageSmoothingEnabled=!0,r.mozImageSmoothingEnabled=!0,r.webkitImageSmoothingEnabled=!0;var d=0;for(var m in shipDB){var h=shipDB[m];if(h.name){var b=$('<img class="tooltip" title="'+h.full+'" src="icons/'+h.type+"/"+m+'.png" id="icon'+m+'"></img>'),y=$('<span id="hit'+m+'">破</span>');b.on("load",function(){d++,$("#loadingProgress").html(d+"/"+Object.keys(shipDB).length),d==Object.keys(shipDB).length&&T()}),0==$(".shipList [data-name='"+h.name+"']").length&&$(".div"+h.type).append("<div><label>"+h.name.replace(new RegExp("_","g")," ")+'</label><div data-name="'+h.name+'" class="'+h.type+'"></div></div>'),h.unique&&$("#colleDiv [data-name='"+h.name+"']").append('<img title="'+h.full+'" src="icons/'+h.type+"/"+m+'.png" id="kore'+m+'"></img>').append(y),$("#avatars [data-name='"+h.name+"']").append(b).append(y)}}$("#colleDiv .shipClasses").each(function(e){var t=$("<div class='colleAll'><input id='selectAll-"+e+"' type='checkbox'/><label for='selectAll-"+e+"'>"+("jp"==lang?"全て選択":"cn"==lang||"tw"==lang?"全選":"Select All")+"</label></div>");$(this).append(t),t.find("input").change(function(){var e=$(this).parent().parent().find("img");for(var t in e.toArray()){var a=$(e[t]);colle[a.attr("id").substring(4)]=this.checked,a.toggleClass("selected",this.checked)}w("colleChangeAll")})}),$(".tooltip").tooltipster(),$(".shipClasses").find("label").next("div").each(function(){0==$(this).find("img").length&&$(this).parent().remove()}),$("#fleetSelect div").click(function(){$("#fleetSelect .chosen").removeClass("chosen"),$(this).toggleClass("chosen");var e=this.id.substring(5);t=parseInt(e)-1,$("#fleets div").html(""),$("#fleetLevels input").val(1);for(var a in fleets[t]){var l=fleets[t][a],i=parseInt(a)+1;null!==l&&""!==l&&$("#slot"+i).html('<img style="height:50px; width:50px;" src="'+$("#"+l).attr("src")+'"/>'),$("#level"+i).val(fleetLevels[t][a])}}),$("#fleets div").click(function(){$("#fleets .chosen").removeClass("chosen"),$(this).toggleClass("chosen");var e=this.id.substring(4);a=parseInt(e)-1}),$("#fleetLevels input").change(function(){var e=this.id.substring(5);a=parseInt(e)-1,fleetLevels[t][a]=this.value,w("fleetLevelChange")}),$("#avatars img").on("click",function(){$(this).hasClass("abyss")||(fleets[t][a]=$(this).attr("id"),$("#fleets .chosen").html('<img style="height:50px; width:50px;" src="'+$(this).attr("src")+'"/>')),0==t&&0==a&&($(".flagship").removeClass("flagship"),$(".damaged").removeClass("damaged"),$(this).toggleClass("flagship"),n=shipDB[this.id.substring(4)]?shipDB[this.id.substring(4)].rarity:0),w("fleetShipChange")}),$("#colleDiv img").on("click",function(){colle[$(this).attr("id").substring(4)]&&$(this).hasClass("selected")?delete colle[$(this).attr("id").substring(4)]:$(this).hasClass("selected")||(colle[$(this).attr("id").substring(4)]=!0),$(this).toggleClass("selected"),w("colleChange")}),$("#avatars span").on("click",x),$(".shipList > label").click(function(){$(this).next("div").slideToggle()}),$(".shipClasses label").click(function(){$(this).next("div").toggle()}),$("#removeSlot").click(function(){0==t&&0==a&&($(".damaged").removeClass("damaged"),$(".flagship").removeClass("flagship"),n=0),fleets[t][a]=null,$("#fleets .chosen").html(""),w("fleetRemoveSlot")}),$(".shipOptions input[type='checkbox']").change(function(){w("kainiShipChange")}),$("#selectAll").on("change",function(){this.checked?$(".shipOptions [type='checkbox']").prop("checked",!0):$(".shipOptions [type='checkbox']").prop("checked",!1),w("kainiSelectAll")}),$("#displayBadge").on("click",function(){$("#buttonToggles button").removeClass("active"),$(this).addClass("active"),o.width=850,o.height=205,w("displayBadge")}),$("#displayRoom").on("click",function(){$("#buttonToggles button").removeClass("active"),$(this).addClass("active"),o.width=850,o.height=510,O(132)}),$("#displayPoster").on("click",function(){$("#buttonToggles button").removeClass("active"),$(this).addClass("active"),o.width=850,o.height=510,w("displayPoster")}),$("#generate").on("click",w),$("#Floor,#Wall,#Desk,#Object,#Chest,#Window").on("change",function(){
var t=this.id;delete e[t];var a=$("#active"+t),l=$(this).find(":checked").val();a.off("load"),a.attr("src","furniture/"+this.id.toLowerCase()+"/"+l+".png"),a.prop("complete")?$.isEmptyObject(e)&&"Window"!=t&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?O(132):w("furnitureChangeCache")):(e[t]=l,$("#buttons button").prop("disabled",!0),$("#loadingDiv").html("Rendering..."),a.load(function(){delete e[t],$.isEmptyObject(e)&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?O(132):w("furnitureChangeLoaded"))}).error(function(){delete e[t],$.isEmptyObject(e)&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html("Couldn't find this furniture's image."))})),"Window"==t&&$("#Outside").change()}),$("#Outside").on("change",function(t){delete e.Outside;var a=$("#activeOutside"),l=$("#Outside").find(":checked"),i=$("#Window").find(":checked").attr("data-pType"),n=l.val()+i,s="furniture/outside/"+n+".png";a.off("load"),a.attr("src",s),a.prop("complete")&&$.isEmptyObject(e)?($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?O(132):w("furnitureOutsideCache")):a.load(function(){delete e.Outside,$.isEmptyObject(e)&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?O(132):w("furnitureOutsideLoaded"))})}),$("#ttkInfo input[type='text'],#ttkInfo input[type='number']").blur(function(){w("ttkInfo")}),$("#ttkInfo select").click(function(){w("ttkServer")}),$("#ttkInfo input[type='checkbox']").click(function(){w("ttkLevel")}),$("#loadAbyss").click(function(){S()}),$("#save").on("click",function(){k(),this.setAttribute("disabled","disabled")}),$("#load").on("click",function(){C()}),$("#export").on("click",function(){alert("Right-click the image that opens up in a new tab and save it as PNG.");var e=o.toDataURL("image/png");window.open(e,"_blank")}),$("#avatar").load(function(){$.isEmptyObject(e)&&w("avatarImgChange")}),$("#bg").load(function(){$.isEmptyObject(e)&&w("bgImgChange")}),$("#customInputs input[type='checkbox']").change(function(){w("customInputChange")}),$("#customInputs input[type='number']").change(function(){w("customInputChange")}),$("#avatarImg").change(function(){if(this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){$("#avatar").attr("src",e.target.result),globalavatar=e.target.result},e.readAsDataURL(this.files[0])}}),$("#shipImg").change(function(){if(this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){$("#customShip").attr("src",e.target.result),globalship=e.target.result,w("customShipChange")},e.readAsDataURL(this.files[0])}}),$("#bgImg").change(function(){if($("#useBG").prop("checked",!1),this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){$("#bg").attr("src",e.target.result),globalbg=e.target.result},e.readAsDataURL(this.files[0])}}),$("#shipClear").click(function(){globalship=null,$("#shipImg").val(""),$("#customShip").removeAttr("src"),w("clear")}),$("#avatarClear").click(function(){globalavatar=null,$("#avatarImg").val(""),$("#avatar").removeAttr("src"),w("clear")}),$("#bgClear").click(function(){globalbg=null,$("#bgImg").val(""),$("#bg").attr("src","bg.jpg"),w("clear")})}}),$(window).load(function(){$("#tabs").liteTabs({width:"100%"}),$("#tabs").show(),$(".furnitureClass.invert > div div").each(function(){$(this).prependTo(this.parentNode)})});
